<!-- 
Deck: 4000 Essential English Words — Immersion & Audio-First Edition [en-en (+zh…)]
Ankiweb: https://ankiweb.net/shared/info/348980197
Maintainer: Campfirium 
Feedback: https://campfirium.info/t/595
Updated: 2025-06-21
-->

<div class="box">
  <div class="top-fixed">
    <div class="word">{{Word}}</div>
    <div class="phonetic transparent">{{IPA}}</div>
  </div>
</div>

<script>
// ===== OneMoreTurn MVP =====
(function() {
  // Read configuration from localStorage (set by back.html)
  var hitCountShow = parseInt(localStorage.getItem('mneme_hit_count_show') || '1');
  var hitPosition = parseInt(localStorage.getItem('mneme_hit_position') || '50');
  var shortHitText = localStorage.getItem('mneme_short_hit_text') || '{count} HIT{!}';
  var longHitText = localStorage.getItem('mneme_long_hit_text') || '{count} HIT{!}';

  if (!hitCountShow) return;

  // 测试参数
  var shortProgressTrigger = 1;  // 每1张显示短进度
  var longProgressTrigger = 2;   // 每2张显示长进度

  // 中心弹窗显示
  function showCenterPopup(message, isLong = false) {
    const popup = document.createElement('div');

    if (isLong) {
      // 长进度：短进度样式放大一倍
      popup.style.cssText = `
        position: fixed;
        top: ${hitPosition}%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #FF6B6B;
        color: white;
        padding: 40px 60px;
        border-radius: 20px;
        font-size: 48px;
        font-weight: bold;
        z-index: 99999;
        box-shadow: 0 16px 32px rgba(0,0,0,0.3);
        text-align: center;
      `;
      setTimeout(() => {
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }
      }, 3000); // 3秒消失
    } else {
      // 短进度：原样式，但可调位置
      popup.style.cssText = `
        position: fixed;
        top: ${hitPosition}%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #FF6B6B;
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-size: 24px;
        font-weight: bold;
        z-index: 99999;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        text-align: center;
      `;
      setTimeout(() => {
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }
      }, 1500); // 1.5秒消失
    }

    popup.innerHTML = message;
    document.body.appendChild(popup);
  }

  function getResetKey() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // 如果当前时间在凌晨4点前，使用前一天的日期作为重置键
    if (now.getHours() < 4) {
      today.setDate(today.getDate() - 1);
    }

    return today.toDateString();
  }

  function checkAndResetCount() {
    const currentResetKey = getResetKey();
    const lastResetKey = localStorage.getItem('omt_last_reset') || '';

    if (currentResetKey !== lastResetKey) {
      // 新的一天（凌晨4点后），重置计数
      localStorage.setItem('omt_count', '0');
      localStorage.setItem('omt_last_reset', currentResetKey);
      return 0;
    }

    return parseInt(localStorage.getItem('omt_count') || '0', 10);
  }

  function getCount() {
    return checkAndResetCount();
  }

  function setCount(count) {
    localStorage.setItem('omt_count', count.toString());
  }

  // 正面加载时触发计数（表示开始学习新卡片）
  const currentCount = getCount() + 1;
  setCount(currentCount);

  // 随机选择文本
  function getRandomText(textList) {
    // 用 | 分割文本
    var texts = textList.split('|');
    // 过滤空文本
    texts = texts.filter(function(text) { return text.trim(); });
    // 如果没有文本，返回默认
    if (texts.length === 0) return '{count} HIT{!}';
    // 随机选择一个
    var randomIndex = Math.floor(Math.random() * texts.length);
    return texts[randomIndex].trim();
  }

  // 占位符替换函数
  function replacePlaceholders(template, count) {
    const exclamations = '!'.repeat(Math.min(count, 10));
    const exclamationCount = Math.min(count, 10);

    return template
      .replace(/\{count\}/g, count)
      .replace(/\{!\}/g, exclamations)
      .replace(/\{!count\}/g, exclamationCount);
  }

  // 检查是否触发长进度（优先级更高）
  if (currentCount % longProgressTrigger === 0) {
    const selectedText = getRandomText(longHitText);
    const message = replacePlaceholders(selectedText, currentCount);
    showCenterPopup(message, true);
  } else if (currentCount % shortProgressTrigger === 0) {
    // 短进度
    const selectedText = getRandomText(shortHitText);
    const message = replacePlaceholders(selectedText, currentCount);
    showCenterPopup(message);
  }
})();
</script>